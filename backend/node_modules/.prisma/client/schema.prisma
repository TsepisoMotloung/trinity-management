// Trinity Management System - Prisma Schema
// Sound/Event Business Management Platform

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ==================== USER & AUTH ====================

model User {
  id           String    @id @default(uuid())
  email        String    @unique
  passwordHash String
  firstName    String
  lastName     String
  phone        String?
  role         Role      @default(EMPLOYEE)
  isActive     Boolean   @default(true)
  lastLoginAt  DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  // Relations
  refreshTokens              RefreshToken[]
  actionLogs                 ActionLog[]
  staffAssignments           StaffAssignment[]
  checkOuts                  CheckOutTransaction[]
  checkIns                   CheckInTransaction[]
  maintenanceTicketsCreated  MaintenanceTicket[]   @relation("CreatedBy")
  maintenanceTicketsAssigned MaintenanceTicket[]   @relation("AssignedTo")
  quotesCreated              Quote[]
  invoicesCreated            Invoice[]
  paymentsRecorded           Payment[]

  @@index([email])
  @@index([role])
}

enum Role {
  ADMIN
  EMPLOYEE
}

model RefreshToken {
  id         String   @id @default(uuid())
  token      String   @unique @db.VarChar(500)
  userId     String
  deviceInfo String?
  ipAddress  String?
  expiresAt  DateTime
  isRevoked  Boolean  @default(false)
  createdAt  DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
}

// ==================== LOGGING ====================

model ActionLog {
  id         String   @id @default(uuid())
  userId     String?
  action     String
  entityType String
  entityId   String?
  details    Json?
  ipAddress  String?
  userAgent  String?  @db.Text
  createdAt  DateTime @default(now())

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([entityType, entityId])
  @@index([createdAt])
}

model ErrorLog {
  id               String           @id @default(uuid())
  severity         ErrorSeverity
  module           String
  message          String           @db.Text
  stackTrace       String?          @db.Text
  traceId          String?
  userId           String?
  requestPath      String?
  requestMethod    String?
  resolutionStatus ResolutionStatus @default(OPEN)
  resolvedAt       DateTime?
  resolvedBy       String?
  resolutionNotes  String?          @db.Text
  createdAt        DateTime         @default(now())

  @@index([severity])
  @@index([module])
  @@index([resolutionStatus])
  @@index([createdAt])
}

enum ErrorSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum ResolutionStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  IGNORED
}

// ==================== EQUIPMENT & INVENTORY ====================

model EquipmentCategory {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?  @db.Text
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  items EquipmentItem[]
}

model EquipmentItem {
  id            String          @id @default(uuid())
  name          String
  description   String?         @db.Text
  categoryId    String
  serialNumber  String?         @unique
  barcode       String?         @unique
  purchaseDate  DateTime?
  purchasePrice Decimal?        @db.Decimal(10, 2)
  currentStatus EquipmentStatus @default(AVAILABLE)
  quantity      Int             @default(1)
  unit          String          @default("piece")
  notes         String?         @db.Text
  imageUrl      String?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  category           EquipmentCategory        @relation(fields: [categoryId], references: [id])
  statusHistory      EquipmentStatusHistory[]
  bookings           EventEquipmentBooking[]
  checkOutItems      CheckOutItem[]
  checkInItems       CheckInItem[]
  maintenanceTickets MaintenanceTicket[]

  @@index([categoryId])
  @@index([currentStatus])
  @@index([barcode])
  @@index([serialNumber])
}

enum EquipmentStatus {
  AVAILABLE
  RESERVED
  IN_USE
  DAMAGED
  UNDER_REPAIR
  LOST
  RETIRED
}

model EquipmentStatusHistory {
  id             String           @id @default(uuid())
  equipmentId    String
  previousStatus EquipmentStatus?
  newStatus      EquipmentStatus
  reason         String?          @db.Text
  changedBy      String?
  createdAt      DateTime         @default(now())

  equipment EquipmentItem @relation(fields: [equipmentId], references: [id], onDelete: Cascade)

  @@index([equipmentId])
  @@index([createdAt])
}

// ==================== CLIENTS ====================

model Client {
  id             String   @id @default(uuid())
  name           String
  contactPerson  String?
  email          String?
  phone          String
  alternatePhone String?
  address        String?  @db.Text
  city           String?
  billingAddress String?  @db.Text
  taxId          String?
  notes          String?  @db.Text
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  events   Event[]
  quotes   Quote[]
  invoices Invoice[]

  @@index([name])
  @@index([phone])
  @@index([email])
}

// ==================== EVENTS ====================

model Event {
  id           String      @id @default(uuid())
  name         String
  eventType    String
  description  String?     @db.Text
  clientId     String
  venue        String
  venueAddress String?     @db.Text
  startDate    DateTime
  endDate      DateTime
  setupTime    DateTime?
  status       EventStatus @default(DRAFT)
  requirements String?     @db.Text
  notes        String?     @db.Text
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  client            Client                  @relation(fields: [clientId], references: [id])
  equipmentBookings EventEquipmentBooking[]
  staffAssignments  StaffAssignment[]
  checkOuts         CheckOutTransaction[]
  checkIns          CheckInTransaction[]
  quotes            Quote[]
  invoices          Invoice[]

  @@index([clientId])
  @@index([startDate, endDate])
  @@index([status])
}

enum EventStatus {
  DRAFT
  QUOTED
  CONFIRMED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

// ==================== EQUIPMENT BOOKING ====================

model EventEquipmentBooking {
  id          String        @id @default(uuid())
  eventId     String
  equipmentId String
  quantity    Int           @default(1)
  notes       String?       @db.Text
  status      BookingStatus @default(PENDING)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  event     Event         @relation(fields: [eventId], references: [id], onDelete: Cascade)
  equipment EquipmentItem @relation(fields: [equipmentId], references: [id])

  @@unique([eventId, equipmentId])
  @@index([eventId])
  @@index([equipmentId])
  @@index([status])
}

enum BookingStatus {
  PENDING
  CONFIRMED
  CHECKED_OUT
  RETURNED
  CANCELLED
}

// ==================== CHECK-OUT / CHECK-IN ====================

model CheckOutTransaction {
  id           String   @id @default(uuid())
  eventId      String
  checkedOutBy String
  checkedOutAt DateTime @default(now())
  notes        String?  @db.Text
  createdAt    DateTime @default(now())

  event            Event          @relation(fields: [eventId], references: [id])
  checkedOutByUser User           @relation(fields: [checkedOutBy], references: [id])
  items            CheckOutItem[]

  @@index([eventId])
  @@index([checkedOutBy])
}

model CheckOutItem {
  id                    String  @id @default(uuid())
  checkOutTransactionId String
  equipmentId           String
  quantity              Int     @default(1)
  condition             String?
  notes                 String? @db.Text

  checkOutTransaction CheckOutTransaction @relation(fields: [checkOutTransactionId], references: [id], onDelete: Cascade)
  equipment           EquipmentItem       @relation(fields: [equipmentId], references: [id])

  @@index([checkOutTransactionId])
  @@index([equipmentId])
}

model CheckInTransaction {
  id           String   @id @default(uuid())
  eventId      String
  checkedInBy  String
  checkedInAt  DateTime @default(now())
  notes        String?  @db.Text
  isReconciled Boolean  @default(false)
  createdAt    DateTime @default(now())

  event           Event         @relation(fields: [eventId], references: [id])
  checkedInByUser User          @relation(fields: [checkedInBy], references: [id])
  items           CheckInItem[]

  @@index([eventId])
  @@index([checkedInBy])
}

model CheckInItem {
  id                   String        @id @default(uuid())
  checkInTransactionId String
  equipmentId          String
  quantity             Int           @default(1)
  returnedQuantity     Int           @default(1)
  condition            ItemCondition @default(GOOD)
  damageNotes          String?       @db.Text
  isShortage           Boolean       @default(false)

  checkInTransaction CheckInTransaction @relation(fields: [checkInTransactionId], references: [id], onDelete: Cascade)
  equipment          EquipmentItem      @relation(fields: [equipmentId], references: [id])

  @@index([checkInTransactionId])
  @@index([equipmentId])
}

enum ItemCondition {
  GOOD
  FAIR
  DAMAGED
  LOST
}

// ==================== STAFF ASSIGNMENTS ====================

model StaffAssignment {
  id        String   @id @default(uuid())
  eventId   String
  userId    String
  role      String
  notes     String?  @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id])

  @@unique([eventId, userId])
  @@index([eventId])
  @@index([userId])
}

// ==================== QUOTES & INVOICES ====================

model Quote {
  id          String      @id @default(uuid())
  quoteNumber String      @unique
  clientId    String
  eventId     String?
  createdById String
  issueDate   DateTime    @default(now())
  validUntil  DateTime
  subtotal    Decimal     @db.Decimal(12, 2)
  taxAmount   Decimal     @default(0) @db.Decimal(12, 2)
  discount    Decimal     @default(0) @db.Decimal(12, 2)
  total       Decimal     @db.Decimal(12, 2)
  status      QuoteStatus @default(DRAFT)
  notes       String?     @db.Text
  terms       String?     @db.Text
  pdfUrl      String?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  client    Client          @relation(fields: [clientId], references: [id])
  event     Event?          @relation(fields: [eventId], references: [id])
  createdBy User            @relation(fields: [createdById], references: [id])
  lineItems QuoteLineItem[]

  @@index([clientId])
  @@index([eventId])
  @@index([status])
  @@index([quoteNumber])
}

enum QuoteStatus {
  DRAFT
  SENT
  ACCEPTED
  REJECTED
  EXPIRED
}

model QuoteLineItem {
  id          String  @id @default(uuid())
  quoteId     String
  description String
  quantity    Int     @default(1)
  unitPrice   Decimal @db.Decimal(10, 2)
  total       Decimal @db.Decimal(12, 2)

  quote Quote @relation(fields: [quoteId], references: [id], onDelete: Cascade)

  @@index([quoteId])
}

model Invoice {
  id            String        @id @default(uuid())
  invoiceNumber String        @unique
  clientId      String
  eventId       String?
  createdById   String
  issueDate     DateTime      @default(now())
  dueDate       DateTime
  subtotal      Decimal       @db.Decimal(12, 2)
  taxAmount     Decimal       @default(0) @db.Decimal(12, 2)
  discount      Decimal       @default(0) @db.Decimal(12, 2)
  total         Decimal       @db.Decimal(12, 2)
  amountPaid    Decimal       @default(0) @db.Decimal(12, 2)
  status        InvoiceStatus @default(DRAFT)
  notes         String?       @db.Text
  terms         String?       @db.Text
  pdfUrl        String?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  client    Client            @relation(fields: [clientId], references: [id])
  event     Event?            @relation(fields: [eventId], references: [id])
  createdBy User              @relation(fields: [createdById], references: [id])
  lineItems InvoiceLineItem[]
  payments  Payment[]

  @@index([clientId])
  @@index([eventId])
  @@index([status])
  @@index([invoiceNumber])
  @@index([dueDate])
}

enum InvoiceStatus {
  DRAFT
  SENT
  PARTIALLY_PAID
  PAID
  OVERDUE
  CANCELLED
}

model InvoiceLineItem {
  id          String  @id @default(uuid())
  invoiceId   String
  description String
  quantity    Int     @default(1)
  unitPrice   Decimal @db.Decimal(10, 2)
  total       Decimal @db.Decimal(12, 2)

  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
}

// ==================== PAYMENTS ====================

model Payment {
  id              String        @id @default(uuid())
  invoiceId       String
  recordedById    String
  amount          Decimal       @db.Decimal(12, 2)
  paymentMethod   PaymentMethod
  paymentDate     DateTime      @default(now())
  referenceNumber String?
  notes           String?       @db.Text
  createdAt       DateTime      @default(now())

  invoice    Invoice @relation(fields: [invoiceId], references: [id])
  recordedBy User    @relation(fields: [recordedById], references: [id])

  @@index([invoiceId])
  @@index([paymentMethod])
  @@index([paymentDate])
}

enum PaymentMethod {
  CASH
  ECOCASH
  MPESA
  EFT
  CARD
  OTHER
}

// ==================== MAINTENANCE ====================

model MaintenanceTicket {
  id                String              @id @default(uuid())
  equipmentId       String
  createdById       String
  assignedToId      String?
  title             String
  description       String              @db.Text
  priority          MaintenancePriority @default(MEDIUM)
  status            MaintenanceStatus   @default(OPEN)
  reportedIssue     String              @db.Text
  diagnosis         String?             @db.Text
  repairNotes       String?             @db.Text
  cost              Decimal?            @db.Decimal(10, 2)
  vendorName        String?
  startedAt         DateTime?
  completedAt       DateTime?
  returnToServiceAt DateTime?
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt

  equipment  EquipmentItem @relation(fields: [equipmentId], references: [id])
  createdBy  User          @relation("CreatedBy", fields: [createdById], references: [id])
  assignedTo User?         @relation("AssignedTo", fields: [assignedToId], references: [id])

  @@index([equipmentId])
  @@index([status])
  @@index([priority])
  @@index([createdById])
}

enum MaintenancePriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum MaintenanceStatus {
  OPEN
  IN_PROGRESS
  PENDING_PARTS
  COMPLETED
  CANCELLED
}

// ==================== ALERTS ====================

model Alert {
  id           String    @id @default(uuid())
  type         AlertType
  title        String
  message      String    @db.Text
  entityType   String?
  entityId     String?
  isRead       Boolean   @default(false)
  isDismissed  Boolean   @default(false)
  scheduledFor DateTime?
  sentAt       DateTime?
  createdAt    DateTime  @default(now())

  @@index([type])
  @@index([isRead])
  @@index([scheduledFor])
}

enum AlertType {
  EVENT_REMINDER
  OVERDUE_RETURN
  MAINTENANCE_DUE
  INVOICE_OVERDUE
  LOW_STOCK
  SYSTEM
}
